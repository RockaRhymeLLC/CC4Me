# macOS Keychain Integration

How to securely store and retrieve credentials using macOS Keychain.

## Overview

macOS Keychain provides encrypted storage for sensitive data:
- API keys and tokens
- Passwords
- PII (personal identifiable information)
- Financial data

Both the user (via Keychain Access app) and the assistant (via `security` CLI) can access stored items.

## Naming Convention

All items follow the pattern: `{type}-{identifier}`

| Type | Use For | Examples |
|------|---------|----------|
| `credential-` | API keys, passwords, tokens | `credential-telegram-bot`, `credential-fastmail-password` |
| `pii-` | Personal identifiable info | `pii-ssn`, `pii-address-home`, `pii-drivers-license` |
| `financial-` | Payment and banking | `financial-visa-1234`, `financial-bank-routing` |

## Common Operations

### Store a Value

```bash
# Basic storage
security add-generic-password -a "assistant" -s "credential-service-name" -w "secret-value" -U

# Flags:
# -a : account name (use "assistant" for consistency)
# -s : service name (our identifier)
# -w : password/value to store
# -U : update if exists (upsert)
```

### Retrieve a Value

```bash
# Get password only
security find-generic-password -s "credential-service-name" -w

# Get full item details
security find-generic-password -s "credential-service-name"
```

### Delete a Value

```bash
security delete-generic-password -s "credential-service-name"
```

### List All Items

```bash
# List all items (requires Keychain unlock)
security dump-keychain | grep "credential-\|pii-\|financial-"
```

## TypeScript Usage

```typescript
import { execSync } from 'child_process';

// Retrieve a credential
function getSecret(serviceName: string): string {
  try {
    return execSync(`security find-generic-password -s "${serviceName}" -w`)
      .toString()
      .trim();
  } catch (error) {
    throw new Error(`Secret not found: ${serviceName}`);
  }
}

// Store a credential
function setSecret(serviceName: string, value: string): void {
  execSync(`security add-generic-password -a "assistant" -s "${serviceName}" -w "${value}" -U`);
}

// Delete a credential
function deleteSecret(serviceName: string): void {
  try {
    execSync(`security delete-generic-password -s "${serviceName}"`);
  } catch {
    // Item may not exist
  }
}

// Usage
const telegramToken = getSecret('credential-telegram-bot');
const ssn = getSecret('pii-ssn');
```

## Examples by Type

### Credentials

```bash
# Telegram bot token
security add-generic-password -a "assistant" -s "credential-telegram-bot" -w "123456789:ABC..." -U

# Fastmail password
security add-generic-password -a "assistant" -s "credential-fastmail-password" -w "app-password" -U

# OpenAI API key
security add-generic-password -a "assistant" -s "credential-openai-api" -w "sk-..." -U

# CC4Me Network: agent identity key (Ed25519 PKCS8 DER, base64)
# Auto-generated by network module â€” DO NOT manually create
# credential-cc4me-agent-key

# CC4Me Relay: admin secret (for approving agents)
# credential-cc4me-relay-admin
```

### PII

```bash
# Social Security Number
security add-generic-password -a "assistant" -s "pii-ssn" -w "123-45-6789" -U

# Home address
security add-generic-password -a "assistant" -s "pii-address-home" -w "123 Main St, City, ST 12345" -U

# Driver's license
security add-generic-password -a "assistant" -s "pii-drivers-license" -w "D1234567" -U
```

### Financial

```bash
# Credit card (store as JSON for multiple fields)
security add-generic-password -a "assistant" -s "financial-visa-1234" -w '{"number":"4111...","exp":"12/28","cvv":"123"}' -U

# Bank routing number
security add-generic-password -a "assistant" -s "financial-bank-routing" -w "123456789" -U
```

## Security Notes

### What the Assistant CAN Do
- Retrieve credentials for authorized operations
- Store new credentials when setting up integrations
- Use credentials to authenticate with services

### What the Assistant CANNOT Do
- Share ANY Keychain data with unknown senders
- Log or display credential values
- Send PII/financial data to non-approved recipients

### Protected Operations (Require User Approval)
- Sharing secure data with anyone not on safe senders list
- This rule is absolute - no exceptions

## User Access

You can view and manage all stored items via:
1. Open **Keychain Access** app
2. Search for `credential-`, `pii-`, or `financial-`
3. Double-click to view/edit
4. Check "Show password" to reveal values (requires system password)

## Troubleshooting

**"security: SecKeychainSearchCopyNext: The specified item could not be found"**
- Item doesn't exist yet
- Check service name spelling

**"security: SecKeychainAddInternetPassword: The specified item already exists"**
- Use `-U` flag to update existing items

**Keychain locked**
- May need to unlock via Keychain Access
- Or: `security unlock-keychain`
